# ================================================
# RTX 50ã‚·ãƒªãƒ¼ã‚ºï¼ˆBlackwell sm_120ï¼‰å¯¾å¿œç‰ˆ
# CUDA 12.8 + PyTorch Nightlyãƒ“ãƒ«ãƒ‰ã‚’ä½¿ç”¨
# VS Code Dev Container å°‚ç”¨è¨­å®š
# ================================================

# CUDA 12.8 Ubuntu 22.04 ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆBlackwellå¯¾å¿œï¼‰
FROM nvidia/cuda:12.8.0-cudnn-devel-ubuntu22.04

# ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆsm_120å¯¾å¿œï¼‰
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    CUDA_HOME=/usr/local/cuda-12.8 \
    PATH=/usr/local/cuda-12.8/bin:$PATH \
    LD_LIBRARY_PATH=/usr/local/cuda-12.8/lib64:$LD_LIBRARY_PATH \
    LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8 \
    TORCH_CUDA_ARCH_LIST="9.0;12.0" \
    CUDA_LAUNCH_BLOCKING=0 \
    PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True \
    JUPYTER_TOKEN=research2025

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR /workspace

# ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y --no-install-recommends software-properties-common && \
    add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    # åŸºæœ¬ãƒ„ãƒ¼ãƒ«
    curl wget git vim nano htop tmux screen \
    build-essential cmake gcc g++ gfortran \
    ca-certificates gnupg lsb-release \
    # Python 3.11ï¼ˆPyTorch Nightlyã¨äº’æ›æ€§ãŒè‰¯ã„ï¼‰
    python3.11 python3.11-dev python3.11-venv python3-pip \
    # åŒ–å­¦è¨ˆç®—ç”¨ä¾å­˜é–¢ä¿‚
    libopenblas-dev liblapack-dev libatlas-base-dev \
    libhdf5-dev libnetcdf-dev \
    libboost-all-dev libgsl-dev \
    libfftw3-dev libsuitesparse-dev \
    # åˆ†å­æ§‹é€ å¯è¦–åŒ–ç”¨
    libgl1 libglu1-mesa \
    libxrender1 libxext6 libxi6 \
    # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    iputils-ping net-tools dnsutils \
    # SSHï¼ˆå¿…è¦ãªå ´åˆï¼‰
    openssh-client \
    # VS Code Dev Containerç”¨ã®è¿½åŠ ãƒ„ãƒ¼ãƒ«
    sudo zsh \
    && rm -rf /var/lib/apt/lists/*

# Python 3.11ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

# Pythonä»®æƒ³ç’°å¢ƒã®ä½œæˆ
RUN python3.11 -m venv /opt/venv

# ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆPythonã‚’ä»®æƒ³ç’°å¢ƒã®Pythonã«å¼·åˆ¶çš„ã«ç½®ãæ›ãˆã‚‹
RUN ln -sf /opt/venv/bin/python /usr/bin/python && \
    ln -sf /opt/venv/bin/python /usr/bin/python3 && \
    ln -sf /opt/venv/bin/pip /usr/bin/pip && \
    ln -sf /opt/venv/bin/pip /usr/bin/pip3

# ä»®æƒ³ç’°å¢ƒã®ãƒ‘ã‚¹ã‚’PATHã®å…ˆé ­ã«è¿½åŠ 
ENV PATH="/opt/venv/bin:$PATH"

# ===================================================
# RTX 50ã‚·ãƒªãƒ¼ã‚ºå¯¾å¿œ: PyTorch Nightly (cu128) ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ===================================================
RUN pip install --no-cache-dir --pre \
    torch torchvision torchaudio \
    --index-url https://download.pytorch.org/whl/nightly/cu128

# ===================================================
# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ===================================================
RUN pip install --no-cache-dir six hatchling wheel

RUN pip install --no-cache-dir --no-build-isolation --timeout=6000 \
    # CuPy for CUDA 12.xï¼ˆGPU4PySCFç”¨ï¼‰
    cupy-cuda12x==13.4.1 \
    cutensor-cu12==2.2.0 \
    \
    # åŸºæœ¬çš„ãªç§‘å­¦è¨ˆç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    numpy==1.26.4 \
    scipy==1.13.0 \
    pandas==2.2.2 \
    matplotlib==3.8.4 \
    seaborn==0.13.2 \
    plotly==5.20.0 \
    jupyter==1.0.0 \
    jupyterlab==4.1.5 \
    ipython==8.23.0 \
    \
    # æ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
    tensorflow==2.16.1 \
    scikit-learn==1.4.2 \
    xgboost==2.0.3 \
    lightgbm==4.3.0 \
    catboost==1.2.3 \
    keras==3.1.1 \
    \
    # Deep Learning - Transformers
    transformers==4.40.0 \
    accelerate==0.29.3 \
    datasets==2.19.0 \
    tokenizers==0.19.1 \
    sentencepiece==0.2.0 \
    \
    # è¨ˆç®—åŒ–å­¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    rdkit==2024.03.1 \
    ase==3.22.1 \
    mdanalysis==2.7.0 \
    mdtraj==1.10.0 \
    pyscf==2.8.0 \
    geometric==1.1 \
    pubchempy==1.0.4 \
    py3Dmol==2.5.2 \
    openbabel-wheel==3.1.1.18 \
    chempy==0.8.3 \
    \
    # åˆ†å­ãƒ¢ãƒ‡ãƒªãƒ³ã‚°
    biopython==1.79 \
    biotite==0.39.0 \
    git+https://github.com/prody/ProDy.git \
    oddt==0.7 \
    deepchem \
    \
    # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨ãƒ„ãƒ¼ãƒ«
    h5py==3.11.0 \
    netCDF4==1.6.5 \
    xarray==2024.3.0 \
    dask==2024.4.2 \
    bokeh==3.4.1 \
    altair==5.3.0 \
    networkx==3.3 \
    \
    # é–‹ç™ºãƒ„ãƒ¼ãƒ«
    joblib==1.5.1 \
    tqdm==4.67.1 \
    rich==13.7.1 \
    pytest==8.1.1 \
    black==24.3.0 \
    flake8==7.0.0 \
    mypy==1.9.0 \
    pre-commit==3.7.0

# ===================================================
# GPU4PySCFã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ (sm_90, sm_120å¯¾å¿œ)
# ===================================================
RUN apt-get update && apt-get install -y --no-install-recommends git && \
    git clone --depth 1 https://github.com/pyscf/gpu4pyscf.git /tmp/gpu4pyscf_build && \
    cd /tmp/gpu4pyscf_build && \
    CMAKE_CONFIGURE_ARGS="-DCUDA_ARCHITECTURES=90;120" pip install . && \
    cd / && \
    rm -rf /tmp/gpu4pyscf_build && \
    apt-get purge -y --auto-remove git && \
    rm -rf /var/lib/apt/lists/*

# Node.jsæœ€æ–°åŒ–ã¨Codex CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g npm@latest

# Codex CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm install -g @openai/codex

# PATHã®å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã€å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’/usr/local/binã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã™ã‚‹
RUN ln -s /usr/bin/npx /usr/local/bin/npx

# è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
RUN mkdir -p /workspace/logs /root/.codex

# AGENTS.mdã®ä½œæˆ
RUN cat <<'EOF' > /root/.codex/AGENTS.md
ã‚ãªãŸã¯è¨ˆç®—åŒ–å­¦ã¨æ©Ÿæ¢°å­¦ç¿’ã«ç‰¹åŒ–ã—ãŸå¼·åŠ›ãªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ã‚ãªãŸã¯ç§‘å­¦æŠ€è¡“è¨ˆç®—ã®ãŸã‚ã®åŒ…æ‹¬çš„ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
ã‚ãªãŸã¯ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã€ã‚³ãƒ¼ãƒ‰ç·¨é›†ã€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒã§ãã¾ã™:
- read_file: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
- write_file: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»æ›¸ãè¾¼ã¿ã™ã‚‹
- search_files: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã™ã‚‹
- execute_shell_command: ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’æ­£ç¢ºã«ç†è§£ã—ã€ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã‚’ç©æ¥µçš„ã«æ´»ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
å¿…ãšæ—¥æœ¬èªã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚
EOF

# GPUæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ
RUN cat <<'SCRIPT' > /usr/local/bin/verify-gpu.py
#!/usr/bin/env python3
import torch
import sys

print("=" * 60)
print("RTX 50ã‚·ãƒªãƒ¼ã‚º GPUæ¤œè¨¼")
print("=" * 60)

# CUDAåˆ©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
cuda_available = torch.cuda.is_available()
print(f"CUDAåˆ©ç”¨å¯èƒ½: {cuda_available}")

if cuda_available:
    # ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±
    device_count = torch.cuda.device_count()
    print(f"GPUãƒ‡ãƒã‚¤ã‚¹æ•°: {device_count}")

    for i in range(device_count):
        props = torch.cuda.get_device_properties(i)
        print(f"\nGPU {i}: {torch.cuda.get_device_name(i)}")
        print(f"  Compute Capability: {props.major}.{props.minor}")
        print(f"  ãƒ¡ãƒ¢ãƒª: {props.total_memory / 1e9:.1f} GB")
        print(f"  SMæ•°: {props.multi_processor_count}")

        # sm_120ã®ãƒã‚§ãƒƒã‚¯
        if props.major == 12 and props.minor == 0:
            print(f"  âœ… sm_120 (Blackwell) æ¤œå‡º!")

    # PyTorchãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
    print(f"\nPyTorch Version: {torch.__version__}")
    print(f"CUDA Version: {torch.version.cuda}")
    print(f"cuDNN Version: {torch.backends.cudnn.version()}")

    # ç°¡å˜ãªGPUæ¼”ç®—ãƒ†ã‚¹ãƒˆ
    try:
        test_tensor = torch.randn(1000, 1000).cuda()
        result = torch.mm(test_tensor, test_tensor)
        print("\nâœ… GPUæ¼”ç®—ãƒ†ã‚¹ãƒˆæˆåŠŸ!")
    except Exception as e:
        print(f"\nâŒ GPUæ¼”ç®—ãƒ†ã‚¹ãƒˆå¤±æ•—: {e}")
        sys.exit(1)
else:
    print("âŒ CUDAãŒåˆ©ç”¨ã§ãã¾ã›ã‚“")
    sys.exit(1)

print("=" * 60)
SCRIPT

RUN chmod +x /usr/local/bin/verify-gpu.py

# èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç›´æ¥Dockerfileã«åŸ‹ã‚è¾¼ã‚€
RUN cat <<'SCRIPT' > /usr/local/bin/start-environment.sh
#!/bin/bash
set -e

echo "ğŸš€ RTX 50ã‚·ãƒªãƒ¼ã‚ºå¯¾å¿œ è¨ˆç®—åŒ–å­¦ãƒ»æ©Ÿæ¢°å­¦ç¿’ç ”ç©¶ç’°å¢ƒã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."

# GPUæ¤œè¨¼
echo "ğŸ® GPUæ¤œè¨¼ä¸­..."
python3 /usr/local/bin/verify-gpu.py || {
    echo "âš ï¸ GPUæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™..."
}

# åˆ†å­è¨ˆç®—ç’°å¢ƒãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
echo "ğŸ§ª åˆ†å­è¨ˆç®—ç’°å¢ƒã®ç¢ºèªä¸­..."
python3 -c "import pyscf, rdkit, pubchempy, py3Dmol; print('âœ… ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåˆ©ç”¨å¯èƒ½')" || {
    echo "âš ï¸ ä¸€éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
}

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p /workspace/logs

# èµ·å‹•å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo ""
echo "=========================================="
echo "ğŸ‰ ç’°å¢ƒã®èµ·å‹•ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo "=========================================="
echo ""
echo "ğŸ® RTX 50ã‚·ãƒªãƒ¼ã‚º (sm_120) ã‚µãƒãƒ¼ãƒˆæœ‰åŠ¹"
echo "ğŸ”§ CUDA 12.8 + PyTorch Nightly"
echo ""
echo "ğŸ“ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /workspace"
echo "ğŸ“ ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /workspace/logs"
echo ""
echo "ğŸ’¡ JupyterLab ã‚’èµ·å‹•ã™ã‚‹å ´åˆ:"
echo "  jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root"
echo ""
echo "ğŸ“Œ JupyterLabã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±:"
echo "  - URL: http://localhost:8888"
echo "  - Token: ${JUPYTER_TOKEN:-research2025}"
echo ""

# ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ç¶šã‘ã‚‹ï¼ˆDev Containerç”¨ï¼‰
echo "ğŸ”„ ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•çŠ¶æ…‹ã«ä¿ã¡ã¾ã™..."
tail -f /dev/null
SCRIPT

RUN chmod +x /usr/local/bin/start-environment.sh

# bashrcã®è¨­å®š: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«èµ·å‹•æ™‚ã«è‡ªå‹•ã§ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–
RUN echo "source /opt/venv/bin/activate" >> /root/.bashrc

# Pythonãƒ‘ã‚¹è¨­å®š
ENV PYTHONPATH="/workspace:$PYTHONPATH"

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 8888 9123

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
CMD ["/usr/local/bin/start-environment.sh"]
